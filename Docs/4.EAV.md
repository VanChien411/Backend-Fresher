## EAV

ƒê·ªãa ch·ªâ gi√∫p l∆∞u ·∫£nh m·∫∑c ƒë·ªãnh
http://localhost.fresher/index.php/admin/customer/file/customer_upload/?isAjax=true

ƒê·ªãa ch·ªâ l·∫•y ·∫£nh preview m·∫∑c ƒë·ªãnh -> x√≥a lu√¥n item ƒë√≥
Magento_Ui/templates/form/element/uploader/preview

``````
<?xml version="1.0"?>
<form xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:noNamespaceSchemaLocation="urn:magento:module:Magento_Ui:etc/ui_configuration.xsd">
    <fieldset name="customer">
        <field name="avatar">
            <argument name="data" xsi:type="array">
                <item name="config" xsi:type="array">
                    <item name="label" xsi:type="string">Avatar</item>
                    <item name="formElement" xsi:type="string">fileUploader</item>
                    <item name="uploaderConfig" xsi:type="array">
                        <item name="url" xsi:type="string">customer/file/customer_upload</item>
                    </item>
                    <item name="elementTmpl" xsi:type="string">ui/form/element/uploader/uploader</item>
                    <item name="dataScope" xsi:type="string">avatar</item>
                    <item name="required" xsi:type="boolean">false</item>
                    <item name="sortOrder" xsi:type="number">10</item>
                    <item name="notice" xsi:type="string">Allowed file types: jpeg, jpg, png, gif</item>
                </item>
            </argument>
        </field>
    </fieldset>
</form>
``````

### T·∫°o field th√™m ·∫£nh avata trong Account Information c·ªßa customer/index/edit/id/1/#

``````
V·ªä tr√≠ l∆∞u ·∫£nh pub/media/customer
c√≥ th·ªÉ chia th√™m c√°c folder nh·ªè theo ch·ªØ c√°i
``````

``````
app/code/Magenest/Movie/
‚îú‚îÄ‚îÄ Setup/
‚îÇ   ‚îî‚îÄ‚îÄ Patch/
‚îÇ       ‚îî‚îÄ‚îÄ Data/
‚îÇ           ‚îî‚îÄ‚îÄ AddCustomerAvatarAttribute.php // Th√™m attribute v√† database 
            SELECT * FROM patch_list 
            WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
‚îú‚îÄ‚îÄ etc/
‚îÇ   ‚îú‚îÄ‚îÄ fieldset.xml
‚îî‚îÄ‚îÄ registration.php
``````

``````
Khi ch·∫°y sai ho·∫∑c c·∫ßn s·ª≠a logic file patch h√£y delete c√°c b·∫£ng li√™n quan

DELETE FROM patch_list WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
SELECT * FROM patch_list WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
DELETE FROM eav_attribute WHERE attribute_code = 'avatar' AND entity_type_id = (
    SELECT entity_type_id FROM eav_entity_type WHERE entity_type_code = 'customer'
);
select * FROM eav_attribute WHERE attribute_code = 'avatar' AND entity_type_id = (
    SELECT entity_type_id FROM eav_entity_type WHERE entity_type_code = 'customer'
);
``````

## Hi·ªÉn th·ªã ·∫£nh ra giao di·ªán

``````
N·∫øu ki·ªÉm tra ·∫£nh theo url l√™n giao di·ªán m√† n√≥ kh√¥ng ho·∫°t th√¨ h√£nh ki·ªÉm tra 
sudo micro /etc/nginx/sites-available/<name>
T√¨m 
include /var/www/html/magento/nginx.conf.sample;

sudo micro /var/www/html/magento/nginx.conf.sample

v√† s·ª≠a 
location /media/customer/ {
      try_files $uri $uri/ /get.php$is_args$args;
    add_header X-Frame-Options "SAMEORIGIN";
}

sudo systemctl reload nginx

``````

C·∫£m ∆°n b·∫°n ƒë√£ cung c·∫•p th√™m th√¥ng tin. ·∫¢nh `car.jpeg` c√≥ v·∫ª ƒë√£ ƒë∆∞·ª£c l∆∞u ƒë√∫ng v·ªã tr√≠ (`pub/media/customer/c/a/car.jpeg`),
v√† quy·ªÅn truy c·∫≠p ƒë√£ ·ªïn.

V·∫•n ƒë·ªÅ gi·ªù nhi·ªÅu kh·∫£ nƒÉng **v·∫´n l√† do c·∫•u h√¨nh Nginx ƒëang ch·∫∑n ho·∫∑c kh√¥ng ph·ª•c v·ª• ƒë√∫ng th∆∞ m·ª•c con `/media/customer/`**.

---

## ‚úÖ H∆∞·ªõng x·ª≠ l√Ω c·ª• th·ªÉ

### 1. üîç X√°c ƒë·ªãnh r√µ ·∫£nh b·∫°n truy c·∫≠p l√† ƒë∆∞·ªùng d·∫´n n√†o?

B·∫°n c·∫ßn truy c·∫≠p ƒë√∫ng URL d·∫°ng:

```
http://localhost.fresher/media/customer/c/a/car.jpeg
```

‚Üí N·∫øu b·∫°n d√πng ƒë√∫ng nh∆∞ v·∫≠y, th√¨ ti·∫øp theo h√£y **ki·ªÉm tra l·∫°i block Nginx x·ª≠ l√Ω `/media/`**.

---

### 2. ‚úÖ Thay to√†n b·ªô block `location /media/` b·∫±ng ƒëo·∫°n sau:

> üìå ƒê·∫£m b·∫£o **cho ph√©p m·ªçi th∆∞ m·ª•c con trong `/media/customer/`** v√† kh√¥ng c√≤n d√≤ng `deny all;`.

```nginx
location /media/ {
    try_files $uri $uri/ /get.php$is_args$args;

    location ~ ^/media/theme_customization/.*\.xml {
        deny all;
    }

    location ~* \.(ico|jpg|jpeg|png|gif|svg|svgz|webp|avif|avifs|js|css|eot|ttf|otf|woff|woff2)$ {
        add_header Cache-Control "public";
        add_header X-Frame-Options "SAMEORIGIN";
        expires +1y;
        try_files $uri $uri/ /get.php$is_args$args;
    }

    location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
        add_header Cache-Control "no-store";
        add_header X-Frame-Options "SAMEORIGIN";
        expires off;
        try_files $uri $uri/ /get.php$is_args$args;
    }

    # ‚ùå X√ìA ho·∫∑c COMMENT c√°c d√≤ng deny d∆∞·ªõi ƒë√¢y n·∫øu c√≤n t·ªìn t·∫°i
    # location /media/customer/ {
    #     deny all;
    # }

    # location /media/downloadable/ {
    #     deny all;
    # }

    # location /media/import/ {
    #     deny all;
    # }

    # location /media/custom_options/ {
    #     deny all;
    # }

    add_header X-Frame-Options "SAMEORIGIN";
}
```

---

### 3. üöÄ Ki·ªÉm tra l·∫°i Nginx

```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

### 4. üì∑ Ki·ªÉm tra l·∫°i URL ·∫£nh trong tr√¨nh duy·ªát

Truy c·∫≠p:

```
http://localhost.fresher/media/customer/c/a/car.jpeg
```

N·∫øu hi·ªán ·∫£nh l√† OK. N·∫øu v·∫´n l·ªói, vui l√≤ng cho m√¨nh bi·∫øt:

* Tr√¨nh duy·ªát b√°o l·ªói g√¨? (404? 403? tr·∫Øng trang?)
* K·∫øt qu·∫£ t·ª´ c√¢u l·ªánh sau:

```bash
curl -I http://localhost.fresher/media/customer/c/a/car.jpeg
```

---

S·∫µn s√†ng gi√∫p b·∫°n ti·∫øp n·∫øu b·∫°n g·ª≠i th√™m ph·∫£n h·ªìi t·ª´ l·ªánh `curl` ho·∫∑c log l·ªói.
