## EAV

Äá»‹a chá»‰ giÃºp lÆ°u áº£nh máº·c Ä‘á»‹nh
http://localhost.fresher/index.php/admin/customer/file/customer_upload/?isAjax=true

### Táº¡o field thÃªm áº£nh avata trong Account Information cá»§a customer/index/edit/id/1/#

``````
Vá»Š trÃ­ lÆ°u áº£nh pub/media/customer
cÃ³ thá»ƒ chia thÃªm cÃ¡c folder nhá» theo chá»¯ cÃ¡i
``````

``````
app/code/Magenest/Movie/
â”œâ”€â”€ Setup/
â”‚   â””â”€â”€ Patch/
â”‚       â””â”€â”€ Data/
â”‚           â””â”€â”€ AddCustomerAvatarAttribute.php // ThÃªm attribute vÃ  database 
            SELECT * FROM patch_list 
            WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
â”œâ”€â”€ etc/
â”‚   â”œâ”€â”€ fieldset.xml
â””â”€â”€ registration.php
``````

``````
Khi cháº¡y sai hoáº·c cáº§n sá»­a logic file patch hÃ£y delete cÃ¡c báº£ng liÃªn quan

DELETE FROM patch_list WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
SELECT * FROM patch_list WHERE patch_name = 'Magenest\\Movie\\Setup\\Patch\\Data\\AddCustomerAvatarAttribute';
DELETE FROM eav_attribute WHERE attribute_code = 'avatar' AND entity_type_id = (
    SELECT entity_type_id FROM eav_entity_type WHERE entity_type_code = 'customer'
);
select * FROM eav_attribute WHERE attribute_code = 'avatar' AND entity_type_id = (
    SELECT entity_type_id FROM eav_entity_type WHERE entity_type_code = 'customer'
);
``````

## Hiá»ƒn thá»‹ áº£nh ra giao diá»‡n

``````
Náº¿u kiá»ƒm tra áº£nh theo url lÃªn giao diá»‡n mÃ  nÃ³ khÃ´ng hoáº¡t thÃ¬ hÃ£nh kiá»ƒm tra 
sudo micro /etc/nginx/sites-available/<name>
TÃ¬m 
include /var/www/html/magento/nginx.conf.sample;

sudo micro /var/www/html/magento/nginx.conf.sample

vÃ  sá»­a 
location /media/customer/ {
      try_files $uri $uri/ /get.php$is_args$args;
    add_header X-Frame-Options "SAMEORIGIN";
}

sudo systemctl reload nginx

``````

Cáº£m Æ¡n báº¡n Ä‘Ã£ cung cáº¥p thÃªm thÃ´ng tin. áº¢nh `car.jpeg` cÃ³ váº» Ä‘Ã£ Ä‘Æ°á»£c lÆ°u Ä‘Ãºng vá»‹ trÃ­ (`pub/media/customer/c/a/car.jpeg`),
vÃ  quyá»n truy cáº­p Ä‘Ã£ á»•n.

Váº¥n Ä‘á» giá» nhiá»u kháº£ nÄƒng **váº«n lÃ  do cáº¥u hÃ¬nh Nginx Ä‘ang cháº·n hoáº·c khÃ´ng phá»¥c vá»¥ Ä‘Ãºng thÆ° má»¥c con `/media/customer/`**.

---

## âœ… HÆ°á»›ng xá»­ lÃ½ cá»¥ thá»ƒ

### 1. ğŸ” XÃ¡c Ä‘á»‹nh rÃµ áº£nh báº¡n truy cáº­p lÃ  Ä‘Æ°á»ng dáº«n nÃ o?

Báº¡n cáº§n truy cáº­p Ä‘Ãºng URL dáº¡ng:

```
http://localhost.fresher/media/customer/c/a/car.jpeg
```

â†’ Náº¿u báº¡n dÃ¹ng Ä‘Ãºng nhÆ° váº­y, thÃ¬ tiáº¿p theo hÃ£y **kiá»ƒm tra láº¡i block Nginx xá»­ lÃ½ `/media/`**.

---

### 2. âœ… Thay toÃ n bá»™ block `location /media/` báº±ng Ä‘oáº¡n sau:

> ğŸ“Œ Äáº£m báº£o **cho phÃ©p má»i thÆ° má»¥c con trong `/media/customer/`** vÃ  khÃ´ng cÃ²n dÃ²ng `deny all;`.

```nginx
location /media/ {
    try_files $uri $uri/ /get.php$is_args$args;

    location ~ ^/media/theme_customization/.*\.xml {
        deny all;
    }

    location ~* \.(ico|jpg|jpeg|png|gif|svg|svgz|webp|avif|avifs|js|css|eot|ttf|otf|woff|woff2)$ {
        add_header Cache-Control "public";
        add_header X-Frame-Options "SAMEORIGIN";
        expires +1y;
        try_files $uri $uri/ /get.php$is_args$args;
    }

    location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
        add_header Cache-Control "no-store";
        add_header X-Frame-Options "SAMEORIGIN";
        expires off;
        try_files $uri $uri/ /get.php$is_args$args;
    }

    # âŒ XÃ“A hoáº·c COMMENT cÃ¡c dÃ²ng deny dÆ°á»›i Ä‘Ã¢y náº¿u cÃ²n tá»“n táº¡i
    # location /media/customer/ {
    #     deny all;
    # }

    # location /media/downloadable/ {
    #     deny all;
    # }

    # location /media/import/ {
    #     deny all;
    # }

    # location /media/custom_options/ {
    #     deny all;
    # }

    add_header X-Frame-Options "SAMEORIGIN";
}
```

---

### 3. ğŸš€ Kiá»ƒm tra láº¡i Nginx

```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

### 4. ğŸ“· Kiá»ƒm tra láº¡i URL áº£nh trong trÃ¬nh duyá»‡t

Truy cáº­p:

```
http://localhost.fresher/media/customer/c/a/car.jpeg
```

Náº¿u hiá»‡n áº£nh lÃ  OK. Náº¿u váº«n lá»—i, vui lÃ²ng cho mÃ¬nh biáº¿t:

* TrÃ¬nh duyá»‡t bÃ¡o lá»—i gÃ¬? (404? 403? tráº¯ng trang?)
* Káº¿t quáº£ tá»« cÃ¢u lá»‡nh sau:

```bash
curl -I http://localhost.fresher/media/customer/c/a/car.jpeg
```

---

Sáºµn sÃ ng giÃºp báº¡n tiáº¿p náº¿u báº¡n gá»­i thÃªm pháº£n há»“i tá»« lá»‡nh `curl` hoáº·c log lá»—i.
